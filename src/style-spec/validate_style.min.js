const validateConstants = require('./validate/validate_constants');
const validate = require('./validate/validate');
const latestStyleSpec = require('./reference/latest');
const validateGlyphsURL = require('./validate/validate_glyphs_url');

const validateSource = require('./validate/validate_source');
const validateLight = require('./validate/validate_light');
const validateLayer = require('./validate/validate_layer');
const validateFilter = require('./validate/validate_filter');
const validatePaintProperty = require('./validate/validate_paint_property');
const validateLayoutProperty = require('./validate/validate_layout_property');

/**
 * Validate a Mapbox GL style against the style specification. This entrypoint,
 * `mapbox-gl-style-spec/lib/validate_style.min`, is designed to produce as
 * small a browserify bundle as possible by omitting unnecessary functionality
 * and legacy style specifications.
 *
 * @private
 * @param {Object} style The style to be validated.
 * @param {Object} [styleSpec] The style specification to validate against.
 *     If omitted, the latest style spec is used.
 * @returns {Array<ValidationError>}
 * @example
 *   var validate = require('mapbox-gl-style-spec/lib/validate_style.min');
 *   var errors = validate(style);
 */
function validateStyleMin(style, styleSpec) {
  styleSpec = styleSpec || latestStyleSpec;

  let errors = [];

  errors = errors.concat(
    validate({
      key: '',
      value: style,
      valueSpec: styleSpec.$root,
      styleSpec: styleSpec,
      style: style,
      objectElementValidators: {
        glyphs: validateGlyphsURL,
        '*': function () {
          return [];
        }
      }
    })
  );

  if (style.constants) {
    errors = errors.concat(
      validateConstants({
        key: 'constants',
        value: style.constants,
        style: style,
        styleSpec: styleSpec
      })
    );
  }

  return sortErrors(errors);
}

validateStyleMin.source = wrapCleanErrors(validateSource);
validateStyleMin.light = wrapCleanErrors(validateLight);
validateStyleMin.layer = wrapCleanErrors(validateLayer);
validateStyleMin.filter = wrapCleanErrors(validateFilter);
validateStyleMin.paintProperty = wrapCleanErrors(validatePaintProperty);
validateStyleMin.layoutProperty = wrapCleanErrors(validateLayoutProperty);

function sortErrors(errors) {
  return [].concat(errors).sort((a, b) => {
    return a.line - b.line;
  });
}

function wrapCleanErrors(inner) {
  return function () {
    return sortErrors(inner.apply(this, arguments));
  };
}

module.exports = validateStyleMin;
